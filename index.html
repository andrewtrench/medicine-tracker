<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PillPal</title>
    <!-- SheetJS library for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 0;
            background-color: #f5f5f5;
        }
        h1 {
            margin: 0;
            padding: 15px 0;
            color: white;
        }
        .time-slot {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .time-header {
            background-color: #4285f4;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
        }
        .medication {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .medication:last-child {
            border-bottom: none;
        }
        input[type="checkbox"] {
            margin-right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .medication.completed .med-name {
            text-decoration: line-through;
            color: #999;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 100;
        }
        .med-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .med-name {
            font-weight: bold;
        }
        .med-instructions {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .date-nav button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .file-input {
            margin: 10px 0;
        }
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-success {
            background: #34a853;
        }
        .btn-warning {
            background: #fbbc05;
        }
        .btn-danger {
            background: #ea4335;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Navbar Styles */
        .navbar {
            background-color: #4285f4;
            color: white;
            text-align: center;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dropdown {
            position: relative;
            display: inline-block;
            float: right;
            margin-right: 15px;
        }

        .menu-button {
            background-color: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 0 10px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content .danger {
            color: #ea4335;
        }

        .dropdown-content hr {
            margin: 0;
            border: none;
            border-top: 1px solid #eee;
        }

        .show {
            display: block;
        }

        .container {
            padding: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 99;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <div class="dropdown">
            <button id="menuButton" class="menu-button">â˜°</button>
            <div id="menuDropdown" class="dropdown-content">
                <a id="uploadButton">Upload Schedule</a>
                <a id="loadDefaultButton">Load Default Schedule</a>
                <a id="downloadTemplateButton">Download Template</a>
                <hr>
                <a id="clearDataButton" class="danger">Clear All App Data</a>
            </div>
        </div>
        <h1>PillPal</h1>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h3>Upload Medication Schedule</h3>
            <p>Select an Excel file with your medication schedule:</p>
            <input type="file" id="excel-file" class="file-input" accept=".xlsx, .xls">
        </div>
    </div>

    <div class="container">
        <div class="date-nav">
            <button id="prev-day">&lt; Previous</button>
            <span id="current-date">Today</span>
            <button id="next-day">Next &gt;</button>
        </div>

        <div id="medication-list">
            <!-- Medications will be populated here -->
        </div>
    </div>

    <div id="toast" class="toast">Message</div>
    <div class="debug-btn" id="debug-btn">?</div>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Default medication data
        const defaultMedicationData = [
            {
                name: "12:00 AM (Early morning pain)",
                meds: [
                    {name: "Oxynorm", instructions: "For breakthrough pain"}
                ]
            },
            {
                name: "6:30 AM (Before Breakfast)",
                meds: [
                    {name: "Clopamon", instructions: ""},
                    {name: "Ondansetron", instructions: ""}
                ]
            },
            {
                name: "7:00 AM (After Breakfast)",
                meds: [
                    {name: "Targinact x2", instructions: ""},
                    {name: "Xeloda", instructions: ""},
                    {name: "Losaar", instructions: "Only if BP is up"},
                    {name: "Amlodipine", instructions: "Only if BP is up"}
                ]
            },
            {
                name: "10:00 AM (Mid-Morning)",
                meds: [
                    {name: "Oxynorm", instructions: "2 tablets"},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "12:30 PM (Before Lunch)",
                meds: [
                    {name: "Clopamon", instructions: "Anti nausea"},
                    {name: "Ondansetron", instructions: "Anti nausea"}
                ]
            },
            {
                name: "12:30 PM",
                meds: [
                    {name: "Lenamet", instructions: "Stops stomach acid"}
                ]
            },
            {
                name: "3:00 PM (Afternoon)",
                meds: [
                    {name: "Oxynorm", instructions: ""},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "6:30 PM (Before Dinner)",
                meds: [
                    {name: "Clopamon", instructions: ""},
                    {name: "Ondansetron", instructions: ""}
                ]
            },
            {
                name: "7:00 PM (Dinner)",
                meds: [
                    {name: "Targinact", instructions: ""},
                    {name: "Xeloda", instructions: ""},
                    {name: "Adco-Simvastatin", instructions: ""}
                ]
            },
            {
                name: "9:00 PM (Night)",
                meds: [
                    {name: "Oxynorm", instructions: ""},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "10:00 PM (Before Bed)",
                meds: [
                    {name: "Movicol", instructions: ""},
                    {name: "Lenamet", instructions: ""}
                ]
            }
        ];

        // Current medication data
        let medicationData = [];

        // Date navigation
        let selectedDate = new Date();

        // DOM elements
        const medList = document.getElementById('medication-list');
        const excelFile = document.getElementById('excel-file');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const currentDateEl = document.getElementById('current-date');
        const debugBtn = document.getElementById('debug-btn');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Menu and modal elements
        const menuButton = document.getElementById('menuButton');
        const menuDropdown = document.getElementById('menuDropdown');
        const uploadButton = document.getElementById('uploadButton');
        const loadDefaultButton = document.getElementById('loadDefaultButton');
        const downloadTemplateButton = document.getElementById('downloadTemplateButton');
        const clearDataButton = document.getElementById('clearDataButton');
        const uploadModal = document.getElementById('uploadModal');
        const closeModal = document.getElementById('closeModal');

        // Initialize
        function init() {
            // Try to load saved medication data
            const savedData = localStorage.getItem('pillpal_medication_data');
            if (savedData) {
                try {
                    medicationData = JSON.parse(savedData);

                    // Ensure 12:00 AM slot is present
                    ensureEarlyMorningTimeSlot();

                    createMedicationList();
                } catch (e) {
                    console.error("Error loading saved medication data:", e);
                    medicationData = [...defaultMedicationData];
                    createMedicationList();
                }
            } else {
                // Use default data
                medicationData = [...defaultMedicationData];
                createMedicationList();
            }

            // Set up event listeners for navigation and data
            prevDayBtn.addEventListener('click', navigateToPreviousDay);
            nextDayBtn.addEventListener('click', navigateToNextDay);
            debugBtn.addEventListener('click', showDebugInfo);
            excelFile.addEventListener('change', handleExcelFile);

            // Menu related event listeners
            menuButton.addEventListener('click', function() {
                menuDropdown.classList.toggle('show');
            });

            // Close the dropdown if clicked outside
            window.addEventListener('click', function(event) {
                if (!event.target.matches('.menu-button')) {
                    if (menuDropdown.classList.contains('show')) {
                        menuDropdown.classList.remove('show');
                    }
                }
            });

            // Menu item actions
            uploadButton.addEventListener('click', function() {
                uploadModal.style.display = 'block';
                menuDropdown.classList.remove('show');
            });

            loadDefaultButton.addEventListener('click', function() {
                loadDefaultData();
                menuDropdown.classList.remove('show');
            });

            downloadTemplateButton.addEventListener('click', function() {
                downloadTemplate();
                menuDropdown.classList.remove('show');
            });

            clearDataButton.addEventListener('click', function() {
                if (confirm("WARNING: This will delete all your medication data and history.\n\nAre you sure you want to continue?")) {
                    clearAllAppData();
                }
                menuDropdown.classList.remove('show');
            });

            // Modal close button
            closeModal.addEventListener('click', function() {
                uploadModal.style.display = 'none';
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target == uploadModal) {
                    uploadModal.style.display = 'none';
                }
            });

            // Update date display
            updateDateDisplay();
        }

        // Create medication list from data
        function createMedicationList() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            // Try to get saved medication statuses
            let savedMeds = {};
            try {
                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    savedMeds = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Error loading saved medications:", e);
            }

            // Clear existing content
            medList.innerHTML = '';

            // Create HTML for each time slot
            medicationData.forEach((slot, slotIndex) => {
                let slotHtml = `
                    <div class="time-slot">
                        <div class="time-header">${slot.name}</div>
                        <div class="time-content">
                `;

                // Add medications for this slot
                slot.meds.forEach((med, medIndex) => {
                    const medId = `med-${slotIndex}-${medIndex}-${dateStr}`;
                    const isChecked = savedMeds[medId] === true;
                    const completedClass = isChecked ? 'medication completed' : 'medication';

                    slotHtml += `
                        <div class="${completedClass}" data-id="${medId}">
                            <input type="checkbox" ${isChecked ? 'checked' : ''}>
                            <div class="med-info">
                                <div class="med-name">${med.name}</div>
                                ${med.instructions ? `<div class="med-instructions">${med.instructions}</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                slotHtml += `
                        </div>
                    </div>
                `;

                medList.innerHTML += slotHtml;
            });

            // Add event listeners to checkboxes and med-info divs
            document.querySelectorAll('.medication').forEach(medDiv => {
                const checkbox = medDiv.querySelector('input[type="checkbox"]');
                const medInfo = medDiv.querySelector('.med-info');
                const medId = medDiv.getAttribute('data-id');
                const medName = medDiv.querySelector('.med-name').textContent;

                // Make the whole med-info clickable
                medInfo.addEventListener('click', function() {
                    checkbox.checked = !checkbox.checked;
                    updateMedicationStatus(medDiv, medId, medName, checkbox.checked);
                });

                // Handle checkbox change
                checkbox.addEventListener('change', function() {
                    updateMedicationStatus(medDiv, medId, medName, this.checked);
                });
            });
        }

        // Update medication status
        function updateMedicationStatus(medDiv, medId, medName, isChecked) {
            const dateStr = selectedDate.toISOString().split('T')[0];

            // Get saved medications
            let savedMeds = {};
            try {
                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    savedMeds = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Error loading saved medications:", e);
            }

            // Update status
            savedMeds[medId] = isChecked;

            // Save back to localStorage
            try {
                localStorage.setItem('pillpal_meds_' + dateStr, JSON.stringify(savedMeds));
            } catch (e) {
                console.error("Error saving medications:", e);
                showToast("Error saving: " + e.message);
                return;
            }

            // Update UI
            if (isChecked) {
                medDiv.classList.add('completed');
                showToast(medName + " marked as taken!");
            } else {
                medDiv.classList.remove('completed');
                showToast(medName + " marked as not taken!");
            }
        }

        // Function to ensure the 12:00 AM time slot exists
        function ensureEarlyMorningTimeSlot() {
            // Check if we already have a 12:00 AM time slot
            const has12AM = medicationData.some(slot =>
                slot.name.toLowerCase().includes('12:00 am'));

            console.log("Checking for 12:00 AM slot:", has12AM ? "Found" : "Not found");

            // If no 12:00 AM slot exists, add it
            if (!has12AM) {
                console.log("Adding missing 12:00 AM (Early morning pain) time slot");

                // Create the new time slot
                const newSlot = {
                    name: "12:00 AM (Early morning pain)",
                    meds: [
                        {name: "Oxynorm", instructions: "For breakthrough pain"}
                    ]
                };

                // Add to medication data
                medicationData.push(newSlot);

                // Resort the medication data to ensure proper order
                medicationData.sort((a, b) => compareTimeSlots(a.name, b.name));

                // Save to localStorage
                try {
                    localStorage.setItem('pillpal_medication_data', JSON.stringify(medicationData));
                    console.log("Data saved with added 12:00 AM slot");
                } catch (e) {
                    console.error("Error saving medication data:", e);
                }

                return true;
            }

            return false;
        }

        // Handle Excel file upload with comprehensive error handling
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            uploadModal.style.display = 'none';

            // Read the Excel file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log("File read successfully, starting to process file:", file.name);
                    const data = new Uint8Array(e.target.result);

                    // Try to read the workbook
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'array' });
                        console.log("Workbook read successfully. Available sheets:", workbook.SheetNames);
                    } catch (error) {
                        console.error("Error reading Excel workbook:", error);
                        showToast("Invalid Excel file format. Please check the file.");
                        showLoading(false);
                        return;
                    }

                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        console.error("No sheets found in workbook");
                        showToast("No sheets found in Excel file");
                        showLoading(false);
                        return;
                    }

                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Log sheet data for debugging
                    console.log("Sheet content snapshot:", XLSX.utils.sheet_to_json(worksheet, { header: 1 }).slice(0, 3));

                    // Convert to JSON
                    let jsonData;
                    try {
                        jsonData = XLSX.utils.sheet_to_json(worksheet);
                        console.log("JSON data sample:", jsonData.slice(0, 2));

                        if (jsonData.length === 0) {
                            console.error("Empty data set or header row issue");
                            showToast("The Excel file appears to be empty or has header issues");
                            showLoading(false);
                            return;
                        }
                    } catch (error) {
                        console.error("Error converting sheet to JSON:", error);
                        showToast("Error parsing Excel data");
                        showLoading(false);
                        return;
                    }

                    // Validate the data structure with detailed logging
                    const validationResult = validateExcelData(jsonData);
                    if (!validationResult.valid) {
                        showToast(validationResult.message);
                        showLoading(false);
                        return;
                    }

                    // Process the data with better error trapping
                    try {
                        processExcelData(jsonData);

                        // Now ensure the 12:00 AM slot is present
                        ensureEarlyMorningTimeSlot();

                        showToast("Medication schedule loaded successfully!");

                        // Explicitly update the UI
                        createMedicationList();
                    } catch (error) {
                        console.error("Error in processing Excel data:", error);
                        showToast("Error processing data: " + (error.message || "Unknown error"));
                    }
                } catch (e) {
                    console.error("General error processing Excel file:", e);
                    showToast("Error processing file: " + (e.message || "Unknown error"));
                } finally {
                    showLoading(false);
                }
            };

            reader.onerror = function(error) {
                console.error("FileReader error:", error);
                showToast("Error reading file");
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
        }

        // Validate Excel data with comprehensive checks and helpful feedback
        function validateExcelData(data) {
            console.log("Validating Excel data structure");

            if (!data || !Array.isArray(data)) {
                console.error("Data is not an array or is null/undefined");
                return { valid: false, message: "Invalid data format" };
            }

            if (data.length === 0) {
                console.error("Data array is empty");
                return { valid: false, message: "The Excel file contains no data" };
            }

            // Check for required columns
            const firstRow = data[0];
            console.log("First row keys:", Object.keys(firstRow));

            if (!firstRow) {
                return { valid: false, message: "Empty data row" };
            }

            // Check if column names are present but with different casing
            const hasTimeSlot = 'TimeSlot' in firstRow || Object.keys(firstRow).some(key =>
                key.toLowerCase() === 'timeslot' || key.toLowerCase() === 'time slot');

            const hasMedicationName = 'MedicationName' in firstRow || Object.keys(firstRow).some(key =>
                key.toLowerCase() === 'medicationname' || key.toLowerCase() === 'medication name' ||
                key.toLowerCase() === 'medication');

            if (!hasTimeSlot && !hasMedicationName) {
                console.error("Missing both required columns");
                return {
                    valid: false,
                    message: "Excel file is missing required columns. Must have 'TimeSlot' and 'MedicationName'"
                };
            }

            if (!hasTimeSlot) {
                console.error("Missing TimeSlot column");
                return { valid: false, message: "Excel file is missing the 'TimeSlot' column" };
            }

            if (!hasMedicationName) {
                console.error("Missing MedicationName column");
                return { valid: false, message: "Excel file is missing the 'MedicationName' column" };
            }

            // Check if there's actual data in the columns
            const emptyTimeSlots = data.filter(row => !row.TimeSlot || row.TimeSlot.trim() === '').length;
            if (emptyTimeSlots > 0) {
                console.warn(`Found ${emptyTimeSlots} rows with empty TimeSlot values`);
            }

            const emptyMedNames = data.filter(row => !row.MedicationName || row.MedicationName.trim() === '').length;
            if (emptyMedNames > 0) {
                console.warn(`Found ${emptyMedNames} rows with empty MedicationName values`);
            }

            return { valid: true, message: "Data validated successfully" };
        }

        // Process Excel data with proper error handling
        function processExcelData(data) {
            console.log("Processing Excel data with", data.length, "rows");

            // Group medications by time slot
            const timeSlots = {};

            // Determine the actual column names used in the file
            const firstRow = data[0];
            const timeSlotKey = 'TimeSlot';
            const medNameKey = 'MedicationName';
            const instructionsKey = 'Instructions';

            data.forEach((row, index) => {
                try {
                    const timeSlot = row[timeSlotKey];
                    const medName = row[medNameKey];

                    // Skip rows with empty essential data
                    if (!timeSlot || !medName) {
                        console.warn(`Row ${index + 1} has missing data: TimeSlot='${timeSlot}', MedName='${medName}'`);
                        return;
                    }

                    const instructions = row[instructionsKey] || '';

                    if (!timeSlots[timeSlot]) {
                        timeSlots[timeSlot] = [];
                    }

                    timeSlots[timeSlot].push({
                        name: medName,
                        instructions: instructions
                    });
                } catch (error) {
                    console.error(`Error processing row ${index + 1}:`, error, row);
                }
            });

            // Check if we have any time slots
            if (Object.keys(timeSlots).length === 0) {
                throw new Error("No valid medication data found in file");
            }

            console.log("Time slots going into medication data:", Object.keys(timeSlots));

            // Convert to our format
            const newMedicationData = Object.keys(timeSlots).map(timeSlot => ({
                name: timeSlot,
                meds: timeSlots[timeSlot]
            }));

            // Sort by time (using proper time comparison)
            newMedicationData.sort((a, b) => {
                return compareTimeSlots(a.name, b.name);
            });

            // Update medication data
            medicationData = newMedicationData;

            // Save to localStorage
            try {
                localStorage.setItem('pillpal_medication_data', JSON.stringify(medicationData));
                console.log("Data saved to localStorage successfully");
            } catch (e) {
                console.error("Error saving medication data:", e);
                throw new Error("Could not save medication data: " + e.message);
            }

            return true;
        }

        // Helper function to compare time slots chronologically - improved version
        function compareTimeSlots(timeA, timeB) {
            // Check specifically for 12:00 AM cases
            const isA12AM = timeA.toLowerCase().includes('12:00 am');
            const isB12AM = timeB.toLowerCase().includes('12:00 am');

            // If one is 12:00 AM, it should come first
            if (isA12AM && !isB12AM) {
                return -1;
            }
            if (!isA12AM && isB12AM) {
                return 1;
            }

            // Extract time parts using a more comprehensive regex
            const timeRegex = /(\d+):?(\d*)\s*(AM|PM)?/i;

            const matchA = timeA.match(timeRegex);
            const matchB = timeB.match(timeRegex);

            // If either doesn't match the time pattern, fall back to string comparison
            if (!matchA || !matchB) {
                return timeA.localeCompare(timeB);
            }

            let hourA = parseInt(matchA[1], 10);
            let hourB = parseInt(matchB[1], 10);

            // Convert to 24-hour format
            const periodA = matchA[3] ? matchA[3].toUpperCase() : null;
            const periodB = matchB[3] ? matchB[3].toUpperCase() : null;

            // Special handling for 12 AM and 12 PM
            if (periodA === 'AM' && hourA === 12) hourA = 0;     // 12:00 AM = 00:00 in 24h
            if (periodA === 'PM' && hourA === 12) hourA = 12;    // 12:00 PM = 12:00 in 24h
            if (periodB === 'AM' && hourB === 12) hourB = 0;     // 12:00 AM = 00:00 in 24h
            if (periodB === 'PM' && hourB === 12) hourB = 12;    // 12:00 PM = 12:00 in 24h

            // Standard conversion for other hours
            if (periodA === 'PM' && hourA < 12) hourA += 12;
            if (periodB === 'PM' && hourB < 12) hourB += 12;

            // Compare hours
            if (hourA !== hourB) {
                return hourA - hourB;
            }

            // If hours are equal, compare minutes
            const minuteA = matchA[2] ? parseInt(matchA[2], 10) : 0;
            const minuteB = matchB[2] ? parseInt(matchB[2], 10) : 0;

            return minuteA - minuteB;
        }

        // Load default data
        function loadDefaultData() {
            medicationData = [...defaultMedicationData];

            // Save to localStorage
            try {
                localStorage.setItem('pillpal_medication_data', JSON.stringify(medicationData));
            } catch (e) {
                console.error("Error saving medication data:", e);
            }

            // Refresh UI
            createMedicationList();
            showToast("Default medication schedule loaded!");
        }

        // Download template Excel file
        function downloadTemplate() {
            // Create workbook
            const wb = XLSX.utils.book_new();

            // Create headers
            const headers = ['TimeSlot', 'MedicationName', 'Instructions'];

            // Create data from current medication data
            const data = [];
            medicationData.forEach(slot => {
                slot.meds.forEach(med => {
                    data.push([slot.name, med.name, med.instructions || '']);
                });
            });

            // Combine headers and data
            const wsData = [headers, ...data];

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Medications');

            // Create instructions sheet
            const instructionsWs = XLSX.utils.aoa_to_sheet([
                ['PillPal Template'],
                [''],
                ['Instructions:'],
                ['1. Do not modify the header row (TimeSlot, MedicationName, Instructions)'],
                ['2. Each row represents one medication at a specific time'],
                ['3. Times should be entered in the format "9:00 AM" or "2:30 PM"'],
                ['4. You can add optional text in parentheses after the time, e.g., "7:00 AM (After Breakfast)"'],
                ['5. The Instructions column is optional']
            ]);

            // Add instructions sheet
            XLSX.utils.book_append_sheet(wb, instructionsWs, 'Instructions');

            // Write to file and download
            XLSX.writeFile(wb, 'PillPal_Schedule_Template.xlsx');
        }

        // Navigate to previous day
        function navigateToPreviousDay() {
            selectedDate.setDate(selectedDate.getDate() - 1);
            updateDateDisplay();
            createMedicationList();
        }

        // Navigate to next day
        function navigateToNextDay() {
            selectedDate.setDate(selectedDate.getDate() + 1);
            updateDateDisplay();
            createMedicationList();
        }

        // Update date display
        function updateDateDisplay() {
            const today = new Date();

            if (selectedDate.toDateString() === today.toDateString()) {
                currentDateEl.textContent = 'Today';
            } else if (selectedDate.toDateString() === new Date(today.setDate(today.getDate() - 1)).toDateString()) {
                currentDateEl.textContent = 'Yesterday';
            } else if (selectedDate.toDateString() === new Date(new Date().setDate(new Date().getDate() + 1)).toDateString()) {
                currentDateEl.textContent = 'Tomorrow';
            } else {
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                currentDateEl.textContent = selectedDate.toLocaleDateString('en-US', options);
            }
        }

        // Function to clear all app data
        function clearAllAppData() {
            try {
                // Clear all PillPal-related data from localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('pillpal_')) {
                        keysToRemove.push(key);
                    }
                }

                // Remove the collected keys
                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Reset to default data
                medicationData = [...defaultMedicationData];
                createMedicationList();

                showToast("All app data has been cleared!");
            } catch (e) {
                console.error("Error clearing data:", e);
                showToast("Error clearing data: " + e.message);
            }
        }

        // Show debug info
        function showDebugInfo() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            let debugInfo = "PillPal Debug Info:\n";
            debugInfo += "- Date: " + dateStr + "\n";
            debugInfo += "- Time slots: " + medicationData.length + "\n";

            // Count total medications
            let totalMeds = 0;
            medicationData.forEach(slot => {
                totalMeds += slot.meds.length;
            });
            debugInfo += "- Total medications: " + totalMeds + "\n";

            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                debugInfo += "- localStorage working: Yes\n";

                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    const savedMeds = JSON.parse(saved);
                    const takenCount = Object.values(savedMeds).filter(Boolean).length;
                    debugInfo += "- Medications taken today: " + takenCount + "\n";
                } else {
                    debugInfo += "- No medications tracked for this date\n";
                }

                // Check if using custom schedule
                const isCustom = localStorage.getItem('pillpal_medication_data') ? "Yes" : "No";
                debugInfo += "- Using custom schedule: " + isCustom + "\n";

                // Check for 12:00 AM slot
                const has12AM = medicationData.some(slot => slot.name.toLowerCase().includes('12:00 am'));
                debugInfo += "- 12:00 AM slot present: " + (has12AM ? "Yes" : "No") + "\n";
            } catch (e) {
                debugInfo += "- localStorage error: " + e.message + "\n";
            }

            alert(debugInfo);
        }

        // Show toast message
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';

            setTimeout(function() {
                toast.style.display = 'none';
            }, 3000);
        }

        // Show/hide loading overlay
        function showLoading(show) {
            if (show) {
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>