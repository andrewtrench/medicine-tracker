<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PillPal</title>
    <!-- SheetJS library for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #4285f4;
            margin-bottom: 20px;
        }
        .time-slot {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .time-header {
            background-color: #4285f4;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
        }
        .medication {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .medication:last-child {
            border-bottom: none;
        }
        input[type="checkbox"] {
            margin-right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .medication.completed .med-name {
            text-decoration: line-through;
            color: #999;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 100;
        }
        .med-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .med-name {
            font-weight: bold;
        }
        .med-instructions {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .date-nav button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .settings-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-input {
            margin: 10px 0;
        }
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-success {
            background: #34a853;
        }
        .btn-warning {
            background: #fbbc05;
        }
        .btn-danger {
            background: #ea4335;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>PillPal</h1>

    <div class="settings-section">
        <h3>Medication Schedule</h3>
        <p>Upload an Excel file with your medication schedule:</p>
        <input type="file" id="excel-file" class="file-input" accept=".xlsx, .xls">
        <button id="load-default" class="btn">Load Default Schedule</button>
        <button id="download-template" class="btn btn-success">Download Template</button>
    </div>

    <div class="date-nav">
        <button id="prev-day">&lt; Previous</button>
        <span id="current-date">Today</span>
        <button id="next-day">Next &gt;</button>
    </div>

    <div id="medication-list">
        <!-- Medications will be populated here -->
    </div>

    <div id="toast" class="toast">Message</div>
    <div class="debug-btn" id="debug-btn">?</div>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Default medication data
        const defaultMedicationData = [
            {
                name: "6:30 AM (Before Breakfast)",
                meds: [
                    {name: "Clopamon", instructions: ""},
                    {name: "Ondansetron", instructions: ""}
                ]
            },
            {
                name: "7:00 AM (After Breakfast)",
                meds: [
                    {name: "Targinact x2", instructions: ""},
                    {name: "Xeloda", instructions: ""},
                    {name: "Losaar", instructions: "Only if BP is up"},
                    {name: "Amlodipine", instructions: "Only if BP is up"}
                ]
            },
            {
                name: "10:00 AM (Mid-Morning)",
                meds: [
                    {name: "Oxynorm", instructions: "2 tablets"},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "12:30 PM (Before Lunch)",
                meds: [
                    {name: "Clopamon", instructions: "Anti nausea"},
                    {name: "Ondansetron", instructions: "Anti nausea"}
                ]
            },
            {
                name: "12:30 PM",
                meds: [
                    {name: "Lenamet", instructions: "Stops stomach acid"}
                ]
            },
            {
                name: "3:00 PM (Afternoon)",
                meds: [
                    {name: "Oxynorm", instructions: ""},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "6:30 PM (Before Dinner)",
                meds: [
                    {name: "Clopamon", instructions: ""},
                    {name: "Ondansetron", instructions: ""}
                ]
            },
            {
                name: "7:00 PM (Dinner)",
                meds: [
                    {name: "Targinact", instructions: ""},
                    {name: "Xeloda", instructions: ""},
                    {name: "Adco-Simvastatin", instructions: ""}
                ]
            },
            {
                name: "9:00 PM (Night)",
                meds: [
                    {name: "Oxynorm", instructions: ""},
                    {name: "Paracetamol", instructions: ""}
                ]
            },
            {
                name: "10:00 PM (Before Bed)",
                meds: [
                    {name: "Movicol", instructions: ""},
                    {name: "Lenamet", instructions: ""}
                ]
            }
        ];

        // Current medication data
        let medicationData = [];

        // Date navigation
        let selectedDate = new Date();

        // DOM elements
        const medList = document.getElementById('medication-list');
        const excelFile = document.getElementById('excel-file');
        const loadDefaultBtn = document.getElementById('load-default');
        const downloadTemplateBtn = document.getElementById('download-template');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const currentDateEl = document.getElementById('current-date');
        const debugBtn = document.getElementById('debug-btn');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Initialize
        function init() {
            // Try to load saved medication data
            const savedData = localStorage.getItem('pillpal_medication_data');
            if (savedData) {
                try {
                    medicationData = JSON.parse(savedData);
                    createMedicationList();
                } catch (e) {
                    console.error("Error loading saved medication data:", e);
                    medicationData = [...defaultMedicationData];
                    createMedicationList();
                }
            } else {
                // Use default data
                medicationData = [...defaultMedicationData];
                createMedicationList();
            }

            // Set up event listeners
            excelFile.addEventListener('change', handleExcelFile);
            loadDefaultBtn.addEventListener('click', loadDefaultData);
            downloadTemplateBtn.addEventListener('click', downloadTemplate);
            prevDayBtn.addEventListener('click', navigateToPreviousDay);
            nextDayBtn.addEventListener('click', navigateToNextDay);
            debugBtn.addEventListener('click', showDebugInfo);

            // Update date display
            updateDateDisplay();
        }

        // Create medication list from data
        function createMedicationList() {
            const dateStr = selectedDate.toISOString().split('T')[0];

            // Try to get saved medication statuses
            let savedMeds = {};
            try {
                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    savedMeds = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Error loading saved medications:", e);
            }

            // Clear existing content
            medList.innerHTML = '';

            // Create HTML for each time slot
            medicationData.forEach((slot, slotIndex) => {
                let slotHtml = `
                    <div class="time-slot">
                        <div class="time-header">${slot.name}</div>
                        <div class="time-content">
                `;

                // Add medications for this slot
                slot.meds.forEach((med, medIndex) => {
                    const medId = `med-${slotIndex}-${medIndex}-${dateStr}`;
                    const isChecked = savedMeds[medId] === true;
                    const completedClass = isChecked ? 'medication completed' : 'medication';

                    slotHtml += `
                        <div class="${completedClass}" data-id="${medId}">
                            <input type="checkbox" ${isChecked ? 'checked' : ''}>
                            <div class="med-info">
                                <div class="med-name">${med.name}</div>
                                ${med.instructions ? `<div class="med-instructions">${med.instructions}</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                slotHtml += `
                        </div>
                    </div>
                `;

                medList.innerHTML += slotHtml;
            });

            // Add event listeners to checkboxes and med-info divs
            document.querySelectorAll('.medication').forEach(medDiv => {
                const checkbox = medDiv.querySelector('input[type="checkbox"]');
                const medInfo = medDiv.querySelector('.med-info');
                const medId = medDiv.getAttribute('data-id');
                const medName = medDiv.querySelector('.med-name').textContent;

                // Make the whole med-info clickable
                medInfo.addEventListener('click', function() {
                    checkbox.checked = !checkbox.checked;
                    updateMedicationStatus(medDiv, medId, medName, checkbox.checked);
                });

                // Handle checkbox change
                checkbox.addEventListener('change', function() {
                    updateMedicationStatus(medDiv, medId, medName, this.checked);
                });
            });
        }

        // Update medication status
        function updateMedicationStatus(medDiv, medId, medName, isChecked) {
            const dateStr = selectedDate.toISOString().split('T')[0];

            // Get saved medications
            let savedMeds = {};
            try {
                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    savedMeds = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Error loading saved medications:", e);
            }

            // Update status
            savedMeds[medId] = isChecked;

            // Save back to localStorage
            try {
                localStorage.setItem('pillpal_meds_' + dateStr, JSON.stringify(savedMeds));
            } catch (e) {
                console.error("Error saving medications:", e);
                showToast("Error saving: " + e.message);
                return;
            }

            // Update UI
            if (isChecked) {
                medDiv.classList.add('completed');
                showToast(medName + " marked as taken!");
            } else {
                medDiv.classList.remove('completed');
                showToast(medName + " marked as not taken!");
            }
        }

        // Handle Excel file upload
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);

            // Read the Excel file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    // Validate the data structure
                    if (!validateExcelData(jsonData)) {
                        showToast("Invalid Excel format. Please use the template.");
                        showLoading(false);
                        return;
                    }

                    // Process the data
                    processExcelData(jsonData);

                    showToast("Medication schedule loaded successfully!");
                } catch (e) {
                    console.error("Error processing Excel file:", e);
                    showToast("Error processing file: " + e.message);
                } finally {
                    showLoading(false);
                }
            };

            reader.onerror = function() {
                showToast("Error reading file");
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
        }

        // Validate Excel data
        function validateExcelData(data) {
            if (!data || !data.length) return false;

            // Check for required columns
            const firstRow = data[0];
            if (!firstRow.TimeSlot || !firstRow.MedicationName) {
                return false;
            }

            return true;
        }

        // Process Excel data
        function processExcelData(data) {
            // Group medications by time slot
            const timeSlots = {};

            data.forEach(row => {
                const timeSlot = row.TimeSlot;
                const medName = row.MedicationName;
                const instructions = row.Instructions || '';

                if (!timeSlots[timeSlot]) {
                    timeSlots[timeSlot] = [];
                }

                timeSlots[timeSlot].push({
                    name: medName,
                    instructions: instructions
                });
            });

            // Convert to our format
            const newMedicationData = Object.keys(timeSlots).map(timeSlot => ({
                name: timeSlot,
                meds: timeSlots[timeSlot]
            }));

            // Sort by time (simple string comparison for now)
            newMedicationData.sort((a, b) => {
                return a.name.localeCompare(b.name);
            });

            // Update medication data
            medicationData = newMedicationData;

            // Save to localStorage
            try {
                localStorage.setItem('pillpal_medication_data', JSON.stringify(medicationData));
            } catch (e) {
                console.error("Error saving medication data:", e);
                showToast("Error saving data: " + e.message);
            }

            // Refresh UI
            createMedicationList();
        }

        // Load default data
        function loadDefaultData() {
            medicationData = [...defaultMedicationData];

            // Save to localStorage
            try {
                localStorage.setItem('pillpal_medication_data', JSON.stringify(medicationData));
            } catch (e) {
                console.error("Error saving medication data:", e);
            }

            // Refresh UI
            createMedicationList();
            showToast("Default medication schedule loaded!");
        }

        // Download template Excel file
        function downloadTemplate() {
            // Create workbook
            const wb = XLSX.utils.book_new();

            // Create headers
            const headers = ['TimeSlot', 'MedicationName', 'Instructions'];

            // Create data from current medication data
            const data = [];
            medicationData.forEach(slot => {
                slot.meds.forEach(med => {
                    data.push([slot.name, med.name, med.instructions || '']);
                });
            });

            // Combine headers and data
            const wsData = [headers, ...data];

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Medications');

            // Create instructions sheet
            const instructionsWs = XLSX.utils.aoa_to_sheet([
                ['PillPal Template'],
                [''],
                ['Instructions:'],
                ['1. Do not modify the header row (TimeSlot, MedicationName, Instructions)'],
                ['2. Each row represents one medication at a specific time'],
                ['3. Times should be entered in the format "9:00 AM" or "2:30 PM"'],
                ['4. You can add optional text in parentheses after the time, e.g., "7:00 AM (After Breakfast)"'],
                ['5. The Instructions column is optional']
            ]);

            // Add instructions sheet
            XLSX.utils.book_append_sheet(wb, instructionsWs, 'Instructions');

            // Write to file and download
            XLSX.writeFile(wb, 'PillPal_Schedule_Template.xlsx');
        }

        // Navigate to previous day
        function navigateToPreviousDay() {
            selectedDate.setDate(selectedDate.getDate() - 1);
            updateDateDisplay();
            createMedicationList();
        }

        // Navigate to next day
        function navigateToNextDay() {
            selectedDate.setDate(selectedDate.getDate() + 1);
            updateDateDisplay();
            createMedicationList();
        }

        // Update date display
        function updateDateDisplay() {
            const today = new Date();

            if (selectedDate.toDateString() === today.toDateString()) {
                currentDateEl.textContent = 'Today';
            } else if (selectedDate.toDateString() === new Date(today.setDate(today.getDate() - 1)).toDateString()) {
                currentDateEl.textContent = 'Yesterday';
            } else if (selectedDate.toDateString() === new Date(new Date().setDate(new Date().getDate() + 1)).toDateString()) {
                currentDateEl.textContent = 'Tomorrow';
            } else {
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                currentDateEl.textContent = selectedDate.toLocaleDateString('en-US', options);
            }
        }

        // Show debug info
        function showDebugInfo() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            let debugInfo = "PillPal Debug Info:\n";
            debugInfo += "- Date: " + dateStr + "\n";
            debugInfo += "- Time slots: " + medicationData.length + "\n";

            // Count total medications
            let totalMeds = 0;
            medicationData.forEach(slot => {
                totalMeds += slot.meds.length;
            });
            debugInfo += "- Total medications: " + totalMeds + "\n";

            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                debugInfo += "- localStorage working: Yes\n";

                const saved = localStorage.getItem('pillpal_meds_' + dateStr);
                if (saved) {
                    const savedMeds = JSON.parse(saved);
                    const takenCount = Object.values(savedMeds).filter(Boolean).length;
                    debugInfo += "- Medications taken today: " + takenCount + "\n";
                } else {
                    debugInfo += "- No medications tracked for this date\n";
                }

                // Check if using custom schedule
                const isCustom = localStorage.getItem('pillpal_medication_data') ? "Yes" : "No";
                debugInfo += "- Using custom schedule: " + isCustom + "\n";
            } catch (e) {
                debugInfo += "- localStorage error: " + e.message + "\n";
            }

            alert(debugInfo);
        }

        // Show toast message
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';

            setTimeout(function() {
                toast.style.display = 'none';
            }, 3000);
        }

        // Show/hide loading overlay
        function showLoading(show) {
            if (show) {
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>